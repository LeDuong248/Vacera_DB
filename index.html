<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacera Analytics Dashboard - Quản lý Khu vực / Đại lý / Mã gạch</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Vacera Analytics</h1>
                    <p class="text-xs text-gray-500">Phân tích Mẫu (<span class="font-bold">≤4</span>) và Đơn Mua (<span
                            class="font-bold">>4</span>)</p>
                </div>
            </div>
            <!-- File Upload Input -->
            <div class="flex items-center gap-2 bg-gray-100 p-1.5 rounded-lg border border-gray-200">
                <label for="upload"
                    class="cursor-pointer bg-white hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-md shadow-sm border border-gray-200 text-sm transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Chọn file Excel
                </label>
                <input type="file" id="upload" accept=".xlsx, .xls, .csv" class="hidden">
                <span id="file-name" class="text-xs text-gray-500 px-2 max-w-[150px] truncate">Chưa chọn file</span>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <!-- Initial Placeholder -->
        <div id="placeholder" class="text-center py-20 border-2 border-dashed border-gray-300 rounded-xl bg-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-xl font-medium text-gray-900 mb-2">Chưa có dữ liệu</h3>
            <p class="text-gray-500 max-w-sm mx-auto">Vui lòng chọn file Excel chứa dữ liệu bán hàng (Matrix) để bắt đầu
                phân tích.</p>
        </div>
        <!-- Dashboard Content (Hidden by default) -->
        <div id="dashboard" class="hidden space-y-8">
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <!-- KPI 1 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tổng Mã Mẫu (≤4)</p>
                            <h3 class="text-2xl font-bold text-blue-600 mt-1" id="kpi-sample">0</h3>
                        </div>
                        <div class="bg-blue-50 p-2 rounded-lg text-blue-600">
                            <span class="text-xs font-bold">SAMPLE</span>
                        </div>
                    </div>
                </div>
                <!-- KPI 2 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tổng Đơn Mua (>4)</p>
                            <h3 class="text-2xl font-bold text-green-600 mt-1" id="kpi-purchase">0</h3>
                        </div>
                        <div class="bg-green-50 p-2 rounded-lg text-green-600">
                            <span class="text-xs font-bold">SALE</span>
                        </div>
                    </div>
                </div>
                <!-- KPI 3 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Số Đại Lý</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-agents">0</h3>
                        </div>
                        <div class="bg-purple-50 p-2 rounded-lg text-purple-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                        </div>
                    </div>
                </div>
                <!-- KPI 4 -->
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Số Sản Phẩm</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-products">0</h3>
                        </div>
                        <div class="bg-orange-50 p-2 rounded-lg text-orange-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart 1: Top Regions -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4">Top Khu Vực Mua Nhiều Nhất</h4>
                    <div class="relative h-64">
                        <canvas id="chart-region"></canvas>
                    </div>
                </div>
                <!-- Chart 2: Top Products -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4">Top Mã Gạch Bán Chạy (>4)</h4>
                    <div class="relative h-64">
                        <canvas id="chart-product"></canvas>
                    </div>
                </div>
                <!-- Chart 3: Top Agents (Full Width) -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4">Top 20 Đại Lý Mua Hàng Tích Cực</h4>
                    <div class="relative h-80">
                        <canvas id="chart-agent"></canvas>
                    </div>
                </div>
            </div>
            <!-- Log Area -->
            <div class="bg-gray-800 text-green-400 p-4 rounded-xl font-mono text-xs overflow-x-auto">
                <p id="system-log">> Ready to analyze...</p>
            </div>
        </div>
    </main>
    <!-- Application Logic -->
    <script>
        // Constants
        const THRESHOLD = 4; // Sample <= 4, Purchase > 4
        // Elements
        const fileInput = document.getElementById('upload');
        const fileNameDisplay = document.getElementById('file-name');
        const systemLog = document.getElementById('system-log');
        const dashboard = document.getElementById('dashboard');
        const placeholder = document.getElementById('placeholder');
        // Chart Instances (to destroy before redrawing)
        let chartRegion, chartAgent, chartProduct;
        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFile);
        // --- Main Logic ---
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            fileNameDisplay.innerText = file.name;
            log(`Reading file: ${file.name}...`);
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    // Assume data is in the first sheet
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 }); // Read as Array of Arrays
                    log(`Parsed ${jsonData.length} rows. Processing matrix...`);
                    processData(jsonData);
                    // Show Dashboard
                    placeholder.classList.add('hidden');
                    dashboard.classList.remove('hidden');
                } catch (err) {
                    console.error(err);
                    log("ERROR: " + err.message);
                    alert("Lỗi đọc file! Hãy chắc chắn là file Excel hợp lệ.");
                }
            };
        }
        function processData(matrix) {
            // 1. Detect Headers
            // Usually Row 0 or 1. Let's find row with 'Đại Lý' or 'Khu Vực'
            let headerRowIndex = -1;
            let headers = [];
            for (let i = 0; i < Math.min(10, matrix.length); i++) {
                const row = matrix[i];
                if (row.some(cell => typeof cell === 'string' && (cell.includes("Đại Lý") || cell.includes("Khu Vực")))) {
                    headerRowIndex = i;
                    headers = row;
                    break;
                }
            }
            if (headerRowIndex === -1) {
                log("Error: Could not find header row (Must contain 'Đại Lý' or 'Khu Vực').");
                return;
            }
            log(`Header found at row ${headerRowIndex + 1}.`);
            // 2. Identify Metadata Columns & Product Columns
            // We assume first few are Metadata, then Products.
            // Let's look for known keys or default to index.
            const colMap = {
                region: -1,
                province: -1,
                agent: -1
            };
            const productColIndices = [];
            headers.forEach((cell, index) => {
                if (!cell) return;
                const c = cell.toString().trim().toLowerCase();
                if (c.includes('khu vực')) colMap.region = index;
                else if (c.includes('tỉnh')) colMap.province = index;
                else if (c.includes('đại lý')) colMap.agent = index;
                else {
                    // Assume it's a product if it's not one of the above and verify it's not empty
                    // User said products are like VAGB...
                    productColIndices.push(index);
                }
            });
            // 3. Iterate Data Rows
            let stats = {
                totalSample: 0,
                totalPurchase: 0,
                totalAgents: 0,
                byRegion: {},
                byAgent: {},
                byProduct: {}
            };
            // Start from row after header
            let agentSet = new Set();
            for (let i = headerRowIndex + 1; i < matrix.length; i++) {
                const row = matrix[i];
                if (!row || row.length === 0) continue;
                // Get Metadata
                const region = (colMap.region > -1 && row[colMap.region]) ? row[colMap.region] : "Unknown";
                const agent = (colMap.agent > -1 && row[colMap.agent]) ? row[colMap.agent] : `Row ${i}`;
                if (agent) agentSet.add(agent);
                // Iterate Products
                productColIndices.forEach(colIdx => {
                    const qty = row[colIdx];
                    const productCode = headers[colIdx];
                    if (typeof qty === 'number' && qty > 0) {
                        // Classify
                        const isSample = qty <= THRESHOLD;
                        const isPurchase = qty > THRESHOLD;
                        // Increment Totals
                        if (isSample) stats.totalSample++;
                        if (isPurchase) stats.totalPurchase++;
                        // Only count "Purchase" volume for Top Charts (or Sample count if needed, but usually Sales is king)
                        // User asked for "Mua nếu sl > 4". Dashboard usually highlights Sales.
                        // Let's sum quantity for purchases? Or just count occurrences? user said "Top Đại lý theo mua (>4)" -> likely Count of products bought > 4 or Sum of Qty.
                        // Let's use SUM of QTY for purchases to show volume, or Count.
                        // Based on screenshot "Số mã gạch" -> Count.
                        // Let's count "Number of SKUs purchased" (Frequency).
                        if (isPurchase) {
                            // Region
                            stats.byRegion[region] = (stats.byRegion[region] || 0) + qty; // Sum quantity
                            // Agent
                            stats.byAgent[agent] = (stats.byAgent[agent] || 0) + qty;
                            // Product
                            stats.byProduct[productCode] = (stats.byProduct[productCode] || 0) + qty;
                        }
                    }
                });
            }
            stats.totalAgents = agentSet.size;
            // 4. Update UI
            updateKPIs(stats, productColIndices.length);
            drawCharts(stats);
            log("Analysis Complete.");
        }
        function updateKPIs(stats, productCount) {
            document.getElementById('kpi-sample').innerText = stats.totalSample.toLocaleString();
            document.getElementById('kpi-purchase').innerText = stats.totalPurchase.toLocaleString();
            document.getElementById('kpi-agents').innerText = stats.totalAgents.toLocaleString();
            document.getElementById('kpi-products').innerText = productCount.toLocaleString();
        }
        function drawCharts(stats) {
            // Helper to sort and slice
            const getTop = (obj, topN = 10) => {
                return Object.entries(obj)
                    .sort((a, b) => b[1] - a[1]) // Descending
                    .slice(0, topN);
            };
            const topRegion = getTop(stats.byRegion, 5);
            const topAgent = getTop(stats.byAgent, 20);
            const topProduct = getTop(stats.byProduct, 10);
            // Chart Configuration Factory
            const createConfig = (label, dataArr, color) => ({
                type: 'bar',
                data: {
                    labels: dataArr.map(i => i[0]),
                    datasets: [{
                        label: label,
                        data: dataArr.map(i => i[1]),
                        backgroundColor: color,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } }
                }
            });
            // Destroy old charts if exist
            if (chartRegion) chartRegion.destroy();
            if (chartAgent) chartAgent.destroy();
            if (chartProduct) chartProduct.destroy();
            // Render New Charts
            chartRegion = new Chart(
                document.getElementById('chart-region'),
                createConfig('Số lượng mua', topRegion, 'rgba(59, 130, 246, 0.8)') // Blue
            );
            chartAgent = new Chart(
                document.getElementById('chart-agent'),
                createConfig('Số lượng mua', topAgent, 'rgba(16, 185, 129, 0.8)') // Green
            );
            chartProduct = new Chart(
                document.getElementById('chart-product'),
                createConfig('Số lượng bán ra', topProduct, 'rgba(249, 115, 22, 0.8)') // Orange
            );
        }
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            systemLog.innerHTML += `<div>[${time}] ${msg}</div>`;
            systemLog.scrollTop = systemLog.scrollHeight;
        }
    </script>
</body>
</html>
