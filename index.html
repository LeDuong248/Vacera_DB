<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vacera Analytics Dashboard - Quản lý Khu vực / Đại lý / Mã gạch</title>
    <!-- Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-50 text-gray-800 min-h-screen">
    <!-- Header -->
    <header class="bg-white border-b sticky top-0 z-30 shadow-sm">
        <div class="max-w-7xl mx-auto px-4 py-4 flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="flex items-center gap-2">
                <div class="bg-blue-600 text-white p-2 rounded-lg">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
                <div>
                    <h1 class="text-xl font-bold text-gray-900">Vacera Analytics</h1>
                    <p class="text-xs text-gray-500">Phân tích Mẫu (<span class="font-bold">≤4</span>) và Đơn Mua (<span
                            class="font-bold">>4</span>)</p>
                </div>
            </div>
            <div class="flex items-center gap-2 bg-gray-100 p-1.5 rounded-lg border border-gray-200">
                <label for="upload"
                    class="cursor-pointer bg-white hover:bg-gray-50 text-gray-700 font-medium py-2 px-4 rounded-md shadow-sm border border-gray-200 text-sm transition flex items-center gap-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12" />
                    </svg>
                    Chọn file Excel
                </label>
                <input type="file" id="upload" accept=".xlsx, .xls, .csv" class="hidden">
                <span id="file-name" class="text-xs text-gray-500 px-2 max-w-[150px] truncate">Chưa chọn file</span>
            </div>
        </div>
    </header>
    <!-- Main Content -->
    <main class="max-w-7xl mx-auto px-4 py-8 space-y-8">
        <!-- Initial Placeholder -->
        <div id="placeholder" class="text-center py-20 border-2 border-dashed border-gray-300 rounded-xl bg-white">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-300 mb-4" fill="none"
                viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                    d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
            </svg>
            <h3 class="text-xl font-medium text-gray-900 mb-2">Chưa có dữ liệu</h3>
            <p class="text-gray-500 max-w-sm mx-auto">Vui lòng chọn file Excel chứa dữ liệu bán hàng (Matrix) để bắt đầu
                phân tích.</p>
        </div>
        <!-- Dashboard Content -->
        <div id="dashboard" class="hidden space-y-6">
            <!-- Filters Section -->
            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100">
                <h4 class="text-sm font-semibold text-gray-700 mb-3 uppercase tracking-wide">Bộ Lọc Dữ Liệu</h4>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- Filter Region -->
                    <select id="filter-region"
                        class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="all">Tất cả Khu Vực</option>
                    </select>
                    <!-- Filter Province -->
                    <select id="filter-province"
                        class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="all">Tất cả Tỉnh Thành</option>
                    </select>
                    <!-- Filter Agent -->
                    <select id="filter-agent"
                        class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="all">Tất cả Đại Lý</option>
                    </select>
                    <!-- Filter Product -->
                    <select id="filter-product"
                        class="w-full px-3 py-2 bg-gray-50 border border-gray-300 rounded-lg text-sm focus:ring-2 focus:ring-blue-500 outline-none">
                        <option value="all">Tất cả Mã Gạch</option>
                    </select>
                </div>
            </div>
            <!-- KPIs -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tổng Mã Mẫu (≤4)</p>
                            <h3 class="text-2xl font-bold text-blue-600 mt-1" id="kpi-sample">0</h3>
                        </div>
                        <div class="bg-blue-50 p-2 rounded-lg text-blue-600">
                            <span class="text-xs font-bold">SAMPLE</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Tổng Đơn Mua (>4)</p>
                            <h3 class="text-2xl font-bold text-green-600 mt-1" id="kpi-purchase">0</h3>
                        </div>
                        <div class="bg-green-50 p-2 rounded-lg text-green-600">
                            <span class="text-xs font-bold">SALE</span>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Số Đại Lý</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-agents">0</h3>
                        </div>
                        <div class="bg-purple-50 p-2 rounded-lg text-purple-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                            </svg>
                        </div>
                    </div>
                </div>
                <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">Số Sản Phẩm (Hiển thị)</p>
                            <h3 class="text-2xl font-bold text-gray-800 mt-1" id="kpi-products">0</h3>
                        </div>
                        <div class="bg-orange-50 p-2 rounded-lg text-orange-600">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M20 7l-8-4-8 4m16 0l-8 4m8-4v10l-8 4m0-10L4 7m8 4v10M4 7v10l8 4" />
                            </svg>
                        </div>
                    </div>
                </div>
            </div>
            <!-- Charts Section -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- Chart 1: Top Regions -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4">Top Khu Vực Mua Nhiều Nhất</h4>
                    <div class="relative h-64">
                        <canvas id="chart-region"></canvas>
                    </div>
                </div>
                <!-- Chart 2: Top Products -->
                <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4">Top Mã Gạch Bán Chạy (>4)</h4>
                    <div class="relative h-64">
                        <canvas id="chart-product"></canvas>
                    </div>
                </div>
                <!-- Chart 3: Top Agents (Full Width) -->
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-sm border border-gray-100">
                    <h4 class="font-bold text-gray-800 mb-4">Top 20 Đại Lý Mua Hàng Tích Cực</h4>
                    <div class="relative h-80">
                        <canvas id="chart-agent"></canvas>
                    </div>
                </div>
            </div>
            <div class="bg-gray-800 text-green-400 p-4 rounded-xl font-mono text-xs overflow-x-auto">
                <p id="system-log">> Ready to analyze...</p>
            </div>
        </div>
    </main>
    <!-- Application Logic -->
    <script>
        const THRESHOLD = 4; // Sample <= 4, Purchase > 4
        // DOM Inputs
        const fileInput = document.getElementById('upload');
        const fileNameDisplay = document.getElementById('file-name');
        const systemLog = document.getElementById('system-log');
        const dashboard = document.getElementById('dashboard');
        const placeholder = document.getElementById('placeholder');
        // Filter Inputs
        const selRegion = document.getElementById('filter-region');
        const selProvince = document.getElementById('filter-province');
        const selAgent = document.getElementById('filter-agent');
        const selProduct = document.getElementById('filter-product');
        let GLOBAL_RAW_DATA = []; // To store parsed data
        let GLOBAL_HEADERS = [];
        let COL_MAP = {};
        let PRODUCT_INDICES = [];
        // Chart Instances
        let chartRegion, chartAgent, chartProduct;
        // --- Event Listeners ---
        fileInput.addEventListener('change', handleFile);
        // Filter Change Events
        selRegion.addEventListener('change', runAnalysis);
        selProvince.addEventListener('change', runAnalysis);
        selAgent.addEventListener('change', runAnalysis);
        selProduct.addEventListener('change', runAnalysis);
        // --- 1. File Parsing ---
        function handleFile(e) {
            const file = e.target.files[0];
            if (!file) return;
            fileNameDisplay.innerText = file.name;
            log(`Reading file: ${file.name}...`);
            const reader = new FileReader();
            reader.readAsArrayBuffer(file);
            reader.onload = (e) => {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, { type: 'array' });
                    const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                    const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });
                    log(`Parsed ${jsonData.length} rows. Initializing data...`);
                    // Parse Data Once
                    parseRawData(jsonData);
                } catch (err) {
                    console.error(err);
                    log("ERROR: " + err.message);
                    alert("Lỗi đọc file! Hãy chắc chắn là file Excel đúng định dạng.");
                }
            };
        }
        function parseRawData(matrix) {
            // Find Header Row
            let headerRowIndex = -1;
            for (let i = 0; i < Math.min(10, matrix.length); i++) {
                const row = matrix[i];
                if (row.some(cell => typeof cell === 'string' && (cell.includes("Đại Lý") || cell.includes("Khu Vực")))) {
                    headerRowIndex = i;
                    GLOBAL_HEADERS = row;
                    break;
                }
            }
            if (headerRowIndex === -1) {
                log("Error: Could not find header row (Must contain 'Đại Lý' or 'Khu Vực').");
                return;
            }
            // Map Columns
            COL_MAP = { region: -1, province: -1, agent: -1 };
            PRODUCT_INDICES = [];
            GLOBAL_HEADERS.forEach((cell, index) => {
                if (!cell) return;
                const c = cell.toString().trim().toLowerCase();
                if (c.includes('khu vực')) COL_MAP.region = index;
                else if (c.includes('tỉnh')) COL_MAP.province = index;
                else if (c.includes('đại lý')) COL_MAP.agent = index;
                else PRODUCT_INDICES.push(index);
            });
            // Store Data (Rows after header)
            GLOBAL_RAW_DATA = matrix.slice(headerRowIndex + 1);
            // Populate Filters
            populateFilters();
            // Run Analysis First Time
            placeholder.classList.add('hidden');
            dashboard.classList.remove('hidden');
            runAnalysis();
        }
        // --- 2. Filter Population ---
        function populateFilters() {
            const regions = new Set();
            const provinces = new Set();
            const agents = new Set();
            const products = new Set();
            // Collect unique values
            GLOBAL_RAW_DATA.forEach(row => {
                if (COL_MAP.region > -1 && row[COL_MAP.region]) regions.add(row[COL_MAP.region]);
                if (COL_MAP.province > -1 && row[COL_MAP.province]) provinces.add(row[COL_MAP.province]);
                if (COL_MAP.agent > -1 && row[COL_MAP.agent]) agents.add(row[COL_MAP.agent]);
            });
            PRODUCT_INDICES.forEach(idx => products.add(GLOBAL_HEADERS[idx]));
            // Helper to fill select
            const fillSelect = (sel, set, defaultText) => {
                sel.innerHTML = `<option value="all">${defaultText}</option>`;
                [...set].sort().forEach(val => {
                    const opt = document.createElement('option');
                    opt.value = val;
                    opt.innerText = val;
                    sel.appendChild(opt);
                });
            };
            fillSelect(selRegion, regions, "Tất cả Khu Vực");
            fillSelect(selProvince, provinces, "Tất cả Tỉnh Thành");
            fillSelect(selAgent, agents, "Tất cả Đại Lý");
            fillSelect(selProduct, products, "Tất cả Mã Hàng");
        }
        // --- 3. Analysis Logic (With Filters) ---
        function runAnalysis() {
            // Get current filter values
            const fRegion = selRegion.value;
            const fProvince = selProvince.value;
            const fAgent = selAgent.value;
            const fProduct = selProduct.value;
            log(`Filtering: R=${fRegion}, P=${fProvince}, A=${fAgent}, Prod=${fProduct}`);
            let stats = {
                totalSample: 0,
                totalPurchase: 0,
                byRegion: {},
                byAgent: {},
                byProduct: {}
            };
            let filteredAgentsSet = new Set();
            // Iterate Rows
            GLOBAL_RAW_DATA.forEach(row => {
                if (!row || row.length === 0) return;
                const rRegion = (COL_MAP.region > -1) ? row[COL_MAP.region] : "Unknown";
                const rProvince = (COL_MAP.province > -1) ? row[COL_MAP.province] : "Unknown";
                const rAgent = (COL_MAP.agent > -1) ? row[COL_MAP.agent] : "Unknown";
                // Check Row Filters
                if (fRegion !== 'all' && rRegion !== fRegion) return;
                if (fProvince !== 'all' && rProvince !== fProvince) return;
                if (fAgent !== 'all' && rAgent !== fAgent) return;
                filteredAgentsSet.add(rAgent);
                // Iterate Products
                PRODUCT_INDICES.forEach(colIdx => {
                    const prodName = GLOBAL_HEADERS[colIdx];
                    // Check Product Filter
                    if (fProduct !== 'all' && prodName !== fProduct) return;
                    const qty = row[colIdx];
                    if (typeof qty === 'number' && qty > 0) {
                        const isSample = qty <= THRESHOLD;
                        const isPurchase = qty > THRESHOLD;
                        if (isSample) stats.totalSample++;
                        if (isPurchase) {
                            stats.totalPurchase++; // Count occurrences of Purchase
                            // Aggregations
                            stats.byRegion[rRegion] = (stats.byRegion[rRegion] || 0) + qty;
                            stats.byAgent[rAgent] = (stats.byAgent[rAgent] || 0) + qty;
                            stats.byProduct[prodName] = (stats.byProduct[prodName] || 0) + qty;
                        }
                    }
                });
            });
            // Update UI
            document.getElementById('kpi-sample').innerText = stats.totalSample.toLocaleString();
            document.getElementById('kpi-purchase').innerText = stats.totalPurchase.toLocaleString();
            document.getElementById('kpi-agents').innerText = filteredAgentsSet.size.toLocaleString();
            // Product Count depends on filter
            let displayedProductCount = (fProduct !== 'all') ? 1 : PRODUCT_INDICES.length;
            document.getElementById('kpi-products').innerText = displayedProductCount.toLocaleString();
            drawCharts(stats);
        }
        // --- 4. Charting ---
        function drawCharts(stats) {
            const getTop = (obj, topN = 10) => Object.entries(obj).sort((a, b) => b[1] - a[1]).slice(0, topN);
            const topRegion = getTop(stats.byRegion, 5);
            const topAgent = getTop(stats.byAgent, 20);
            const topProduct = getTop(stats.byProduct, 10);
            const createConfig = (label, dataArr, color) => ({
                type: 'bar',
                data: {
                    labels: dataArr.map(i => i[0]),
                    datasets: [{
                        label: label,
                        data: dataArr.map(i => i[1]),
                        backgroundColor: color,
                        borderRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: { y: { beginAtZero: true } }
                }
            });
            if (chartRegion) chartRegion.destroy();
            if (chartAgent) chartAgent.destroy();
            if (chartProduct) chartProduct.destroy();
            chartRegion = new Chart(document.getElementById('chart-region'), createConfig('Số lượng mua', topRegion, 'rgba(59, 130, 246, 0.8)'));
            chartAgent = new Chart(document.getElementById('chart-agent'), createConfig('Số lượng mua', topAgent, 'rgba(16, 185, 129, 0.8)'));
            chartProduct = new Chart(document.getElementById('chart-product'), createConfig('Số lượng bán ra', topProduct, 'rgba(249, 115, 22, 0.8)'));
        }
        function log(msg) {
            const time = new Date().toLocaleTimeString();
            systemLog.innerHTML += `<div>[${time}] ${msg}</div>`;
            systemLog.scrollTop = systemLog.scrollHeight;
        }
    </script>
</body>
</html>
